@using Bunit
@using Bunit.Rendering
@using AngleSharp.Dom
@using AngleSharp.Html.Dom
@using StpFoodBlazor.Components.Pages
@using StpFoodBlazor.Services
@using StpFoodBlazorTest.Services

@code {

    private TestContext ctx;
    private TestTimeService timeService = new TestTimeService();

    public DealsTest()
    {
        ctx = new TestContext();
        ctx.Services.AddSingleton<IDealService>(new TestDealService());
        ctx.Services.AddSingleton<ITimeService>(timeService);
    }

    [Fact]
    public void DealsShouldDisplayAllColumnsWednesday()
    {
        timeService.DayOfWeek = DayOfWeek.Wednesday.ToString();
        var cut = ctx.Render(@<Deals />);
        var elements = getElements(cut);

        Assert.Equal("Wednesday", elements.Children[0].Children[0].InnerHtml);
        Assert.Equal("1881 by Lake Elmo Inn", elements.Children[0].Children[1].InnerHtml);
        Assert.Equal("$10 select craft cocktail", elements.Children[0].Children[2].InnerHtml);
    }

    [Fact]
    public void DealsShouldDisplayAllColumnsThursday()
    {
        timeService.DayOfWeek = DayOfWeek.Thursday.ToString();
        var cut = ctx.Render(@<Deals />);
        var elements = getElements(cut);

        Assert.Equal("Thursday", elements.Children[0].Children[0].InnerHtml);
        Assert.Equal("1881 by Lake Elmo Inn", elements.Children[0].Children[1].InnerHtml);
        Assert.Equal("$10 select craft cocktail", elements.Children[0].Children[2].InnerHtml);
    }

    [Fact]
    public void DealsShouldDisplayOnlyDealsForSelectedDay()
    {
        timeService.DayOfWeek = DayOfWeek.Wednesday.ToString();
        var cut = ctx.Render(@<Deals />);
        var elements = getElements(cut);

        Assert.Equal(55, elements.ChildElementCount);
        foreach (var tr in elements.Children)
        {
            Assert.Equal("Wednesday", tr.Children[0].InnerHtml);
        }
    }

    [Fact]
    public void DealsShouldDefaultToCurrentDay()
    {
        ctx.Services.AddSingleton<ITimeService>(timeService);
        var cut = ctx.Render(@<Deals />);
        var dowSelect = (IHtmlSelectElement)cut.WaitForElement("#day-of-week-select");

        Assert.Equal(DateTime.Today.DayOfWeek.ToString(), dowSelect.Value);
    }

    [Fact]
    public void DealsShouldChangeWhenNewValueSelectedMonday()
    {
        var cut = ctx.Render(@<Deals />);
        var dowSelect = (IHtmlSelectElement)cut.WaitForElement("#day-of-week-select");

        dowSelect.Change("Monday");

        var elements = getElements(cut);
        Assert.Equal(45, elements.ChildElementCount);
        foreach (var tr in elements.Children)
        {
            Assert.Equal("Monday", tr.Children[0].InnerHtml);
        }
    }

    [Fact]
    public void DealsShouldChangeWhenNewValueSelectedFriday()
    {
        var cut = ctx.Render(@<Deals />);
        var dowSelect = (IHtmlSelectElement)cut.WaitForElement("#day-of-week-select");

        dowSelect.Change("Friday");

        var elements = getElements(cut);
        Assert.Equal(51, elements.ChildElementCount);
        foreach (var tr in elements.Children)
        {
            Assert.Equal("Friday", tr.Children[0].InnerHtml);
        }
    }

    private IElement getElements(IRenderedFragment cut)
    {
        cut.WaitForElement("#deals_table_body", TimeSpan.FromSeconds(5));
        return cut.Find("#deals_table_body");
    }
}
